---
title: "Midterm Report"
author: "Xinxiang Gao"
output: 
  # pdf_document: default
  html_document: default
# link-citations: yes
bibliography: ref.bib
---

```{r, warning=FALSE, message=FALSE}
library(kableExtra)
library(randomForest)
library(caret)
library(DiagrammeR)
library(xgboost)
library(MASS)
library(knitr)
library(tidyverse)
library(skimr)
library(foreign)
library(cowplot)
library(gridExtra)
library(nhanesA)
library(rpart)
library(plotly)
```

```{r}
slq_p <- nhanes('P_SLQ', includelabels = TRUE, cleanse_numeric = TRUE)
dpq_p <- nhanes('P_DPQ', includelabels = TRUE, cleanse_numeric = TRUE, translated = FALSE)
alq_p <- nhanes('P_ALQ', includelabels = TRUE, cleanse_numeric = TRUE)
cdq_p <- nhanes('P_CDQ', includelabels = TRUE, cleanse_numeric = TRUE, translated = FALSE)
demo_p <- nhanes('P_DEMO', includelabels = TRUE, cleanse_numeric = TRUE)
```


```{r}
dpq_p_m <- dpq_p %>% 
  mutate_all(~ ifelse(. %in% c(7, 9, '.', ''), NA, .))
dpq_p_m <- dpq_p_m %>% 
  mutate(score = rowSums(dpq_p_m, na.rm = TRUE) - SEQN) %>% 
  mutate(extent = ifelse(score < 10, "rare", 
                         ifelse(score >= 15, "severe", "normal"))) %>% 
  select(SEQN, score)
```

```{r}
cdq_p_m <- cdq_p %>%
  mutate(
    Grade1_Angina = ifelse(CDQ001 == 1 & CDQ002 == 1 & CDQ003 != 1 & CDQ004 == 1 & CDQ005 == 1 & CDQ006 == 1 & ((CDQ009D == 4 | CDQ009E == 5) | (CDQ009F == 6 & CDQ009G == 7)), TRUE, FALSE),
    Grade2_Angina = ifelse(CDQ001 == 1 & CDQ002 == 1 & CDQ003 == 1 & CDQ004 == 1 & CDQ005 == 1 & CDQ006 == 1 & ((CDQ009D == 4 | CDQ009E == 5) | (CDQ009F == 6 & CDQ009G == 7)), TRUE, FALSE)
  ) %>% 
  mutate(
    Grade1_Angina = replace_na(Grade1_Angina, FALSE),
    Grade2_Angina = replace_na(Grade2_Angina, FALSE)
  ) %>% 
  mutate(Angina = (Grade1_Angina|Grade2_Angina)) %>% 
  select(SEQN, Grade1_Angina, Grade2_Angina, Angina, CDQ008, CDQ010) %>% 
  mutate_all(~ ifelse(. %in% c(7, 9, '.', ''), NA, .))
```

```{r}
slq_p_m <- slq_p %>% 
  mutate(duration_avg = SLD012 * 5/7 + SLD013 * 2/7) %>% 
  mutate(if_enough_sleep = as.factor(ifelse(duration_avg >= 7, TRUE, FALSE)))
```

```{r warning=FALSE}
sleep_duration_plot <- plot_ly(slq_p_m) %>% 
  add_histogram(x = ~SLD012, name = "Weekday", alpha = 0.6, nbinsx = 22) %>% 
  add_histogram(x = ~SLD013, name = "Weekend", alpha = 0.6, nbinsx = 22) %>% 
  layout(title = "Sleep duration of Weekdays and Weekends",
    xaxis = list(title = "Sleep Duration"), 
         yaxis = list(title = "Frequency"),
         barmode = "overlay",
    hovermode = "compare")
sleep_duration_plot
```


```{r}
slq_p_m_2 <- slq_p_m %>% 
  select(SEQN, SLQ030, SLQ050, SLQ120, SLQ030, duration_avg, if_enough_sleep)
```


```{r}
demo_p_m <- demo_p %>% 
  filter(RIDAGEYR >= 18 & RIDAGEYR <= 60) %>% 
  select(SEQN, RIAGENDR, DMDEDUC2, RIDAGEYR)
```

```{r}
alq_p_m <- alq_p %>% 
  select(-ALQ290, -ALQ280, -ALQ270, -ALQ111, -ALQ130, -ALQ151)
```

```{r}
all_p_m_plot <- demo_p_m %>% 
  left_join(slq_p_m_2, by = join_by(SEQN)) %>% 
  left_join(dpq_p_m, by = join_by(SEQN)) %>% 
  left_join(alq_p_m, by = join_by(SEQN)) %>% 
  mutate_if(is.factor, as.character) %>% 
  drop_na() %>% 
  select(-SEQN)

all_p_m_plot[all_p_m_plot == "Don't know"] <- NA
all_p_m_plot[all_p_m_plot == "Refused"] <- NA

all_p_m_plot <- all_p_m_plot %>% 
  mutate_if(is.character, as.factor) %>% 
  drop_na()
```

```{r}
all_p_m <- all_p_m_plot %>% 
  select(-duration_avg)
skim(all_p_m)
```

```{r}
all_p_mr <- all_p_m %>%
  rename(
    gender = RIAGENDR, 
    education_level = DMDEDUC2,
    age = RIDAGEYR,
    snore_freq = SLQ030,
    if_trouble_sleeping = SLQ050,
    feel_sleepy_freq = SLQ120,
    if_enough_sleep = if_enough_sleep,
    depression_score = score,
    drink_freq_last_year = ALQ121,
    more_drink_freq = ALQ142,
    more_drink_30days = ALQ170
  )
```

```{r}
library(dplyr)
library(tidyr)
library(kableExtra)

table_list <- list()

for (col in colnames(all_p_mr)) {
  # Check if the column is a factor
  if (is.factor(all_p_mr[[col]])) {
    # Create a table with value-count pairs for the factor column
    table <- all_p_mr %>%
      count(!!sym(col)) %>%
      rename(Value = !!sym(col), Count = n) %>%
      kable("html", caption = paste("Table of", col)) %>%
      kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
    
    # Add the table to the list
    table_list[[length(table_list) + 1]] <- table
  }
}

table_list

```


```{r}
plot_list <- list()

# Iterate through each factor column in the dataframe
for (col in colnames(all_p_mr)) {
  # Check if the column is a factor
  if (is.factor(all_p_mr[[col]]) ) {
    # Create a summary table of factor levels and their counts
    summary_table <- table(all_p_mr[[col]])
    
    # Convert the summary table to a data frame
    summary_df <- as.data.frame(summary_table)
    colnames(summary_df) <- c(col, "Count")
    
    # Reorder the factor levels based on their counts in descending order
    summary_df <- summary_df[order(summary_df$Count), ]
    
    # Convert the factor column to ordered factor with the new order
    all_p_mr[[col]] <- factor(all_p_mr[[col]], levels = summary_df[[col]])
    
    # Create a barplot for the factor column
    p <- ggplot(all_p_mr, aes(x = .data[[col]])) +
      geom_bar(fill = "lightblue") +
      labs(title = paste("Barplot of", col),
           x = col,
           y = "Count") +
      coord_flip()
    
    # Add the plot to the list
    plot_list[[length(plot_list) + 1]] <- p
    file_name <- paste0(col, ".png")
    ggsave(filename = file_name, plot = p, device = "png")
  }
  else if (col == "depression_score" | col == "age") {
    p <- ggplot(all_p_mr, aes(x = .data[[col]])) +
      geom_bar(fill = "lightblue") +
      labs(title = paste("Barplot of", col),
           x = col,
           y = "Count") +
      coord_flip()
    
    # Add the plot to the list
    plot_list[[length(plot_list) + 1]] <- p
    file_name <- paste0(col, ".png")
    ggsave(filename = file_name, plot = p, device = "png")
  }
}
```

```{r}
tables_list <- list()

# Iterate through each column in the dataframe
for (col in colnames(all_p_mr)) {
  # Check if the column is a factor
  if (is.factor(all_p_mr[[col]])) {
    # Create a table of unique values for the factor column
    unique_table <- table(all_p_mr[[col]])
    unique_df <- as.data.frame(unique_table)
    names(unique_df) <- c("Value", "Count")
    unique_df$Value <- paste(unique_df$Value, "(", unique_df$Count, ")", sep = "")
    unique_df$Variable <- col
    unique_df <- unique_df[, -2]
    # Add the table to the list
    tables_list[[length(tables_list) + 1]] <- unique_df
  }
}

# Combine all tables into a single dataframe
combined_table <- do.call(rbind, tables_list)

# Print the table using kableExtra
combined_table %>%
  kable("html") %>%
  kable_styling(full_width = FALSE)
```


```{r}
unique(all_p_mr$if_enough_sleep)
all_p_mr$if_enough_sleep <- as.factor(all_p_mr$if_enough_sleep)
glm_model <- glm(if_enough_sleep ~ ., all_p_mr, family = binomial(link = logit))
stepAIC(glm_model, direction = "both")
```

```{r}

```

```{r}
glm_aic <- glm(formula = if_enough_sleep ~ gender + education_level + age + 
    snore_freq + feel_sleepy_freq + depression_score, family = binomial(link = logit), 
    data = all_p_mr)

summary(glm_aic)
```


```{r}
full_model <- glm(if_enough_sleep ~ gender + education_level + age + snore_freq + feel_sleepy_freq + depression_score, 
                  family = binomial(link = logit), data = all_p_mr)
# Extract coefficients
coefficients <- coef(full_model)[-1]  # Exclude intercept
std_errors <- summary(full_model)$coefficients[, "Std. Error"][-1]

# Calculate Wald Chi-Square statistics
wald_stats <- (coefficients / std_errors)^2

# Calculate importance scores
importance_scores <- wald_stats / sum(wald_stats)

# Assign names to importance scores
names(importance_scores) <- names(coefficients)

importance_data <- data.frame(variable = names(coefficients),
                              importance = importance_scores)

# Plot using ggplot
ggplot(importance_data, aes(x = reorder(variable, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Relative Variable Importance (Wald Chi-Square)",
       x = "Variables",
       y = "Importance Score") +
  coord_flip()

```


```{r}
p1 <- ggplot(all_p_mr, aes(x=education_level, fill = if_enough_sleep)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Adequate Sleep by education level",
       x = "Education level",
       y = "Proportion") +
  coord_flip()
ggsave(filename = "proportion_of_adequate_sleep_by_education_level.png", plot = p1, device = "png")
ggplotly(p1)
p1
```


```{r}
bag <- randomForest(
  if_enough_sleep ~.,
  data = all_p_mr,
  na.action = na.omit,
)

varImpPlot(
  bag,
  cex.lab = 1.5, cex.axis = 2, cex = 1.3,
  n.var = 13, col = "red4", main = "", pch = 16)
```



```{r}
set.seed(370)
param_grid <- expand.grid(
  eta = seq(0.01, 0.2, by = 0.04),
  nrounds = 500,
  max_depth = c(3, 6, 9),
  gamma = 0,
  subsample = 1,
  min_child_weight = 1,
  colsample_bytree = 0.6
)

ctrl <- trainControl(method = "cv", 
                     number = 5,
                     search = "grid")

xgb_model <- caret::train(
  if_enough_sleep ~.,
  data = all_p_mr,
  na.action = na.omit,
  method = "xgbTree",
  trControl = ctrl,
  tuneGrid = param_grid,
  verbosity = 0
)
plot(xgb_model)
```

```{r}
xgb_model$bestTune
```


```{r}
varimp <- varImp(xgb_model)
ggplot(varimp)
```

```{r}
p3 <- ggplot(all_p_mr, aes(x=age, fill = if_enough_sleep)) +
  geom_histogram(position = "fill")

age_plot <- ggplot(all_p_mr, aes(x=age, fill = if_enough_sleep)) +
  geom_bar(position = "fill") + 
  labs(title = "Proportion of Adequate Sleep by age",
       x = "Age",
       y = "Proportion")

ggsave("proportion_of_adequate_sleep_by_age.png", plot = age_plot, device = "png")

sleep_by_age_plot <- ggplotly(p3) %>% 
  layout(barmode = "overlay",
    hovermode = "compare")

dep_plot <- ggplot(all_p_mr, aes(x=depression_score)) +
  geom_bar(position = position_dodge())

p4 <- ggplot(all_p_mr, aes(x=depression_score, fill = if_enough_sleep)) +
  geom_histogram(position = "fill") + 
  labs(title = "Proportion of Adequate Sleep by depression score",
       x = "Score",
       y = "Proportion")
dep_by_age_plot <- ggplotly(p4) %>% 
  layout(barmode = "overlay",
    hovermode = "compare")
ggsave("proportion_of_adequate_sleep_by_score.png", plot = p4, device = "png")
age_plot
ggplotly(dep_by_age_plot)
```

```{r}
p5 <- ggplot(all_p_mr, aes(x=gender, fill = if_enough_sleep)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Adequate Sleep by Gender",
       x = "Gender",
       y = "Proportion") +
  theme_minimal() +  # Example theme, change as needed
  theme(legend.position = "bottom")  # Adjust legend position
plotly_p5 <- ggplotly(p5) %>% 
  layout(barmode = "overlay",
    hovermode = "compare")

ggsave(filename = "proportion_of_adequate_sleep_by_gender.png", plot = p5, device = "png")
```

```{r}
p6 <- ggplot(all_p_mr, aes(x=feel_sleepy_freq, fill = if_enough_sleep)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Adequate Sleep by Sleep feeling",
       x = "Feeling sleepy frequency",
       y = "Proportion") +
  coord_flip()+
  theme(legend.position = "bottom")  # Adjust legend position
plotly_p6 <- ggplotly(p6) %>% 
  layout(barmode = "overlay",
    hovermode = "compare")

ggsave(filename = "proportion_of_adequate_sleep_by_feel.png", plot = p5, device = "png")
```

```{r}
p7 <- ggplot(all_p_mr, aes(x=if_trouble_sleeping, fill = if_enough_sleep)) +
  geom_bar(position = "fill") + 
  labs(title = "Proportion of Adequate Sleep by whether having trouble sleeping",
       x = "If have trouble sleeping",
       y = "Proportion")
plotly_p7 <- ggplotly(p7) %>% 
  layout(barmode = "overlay",
    hovermode = "compare")
ggsave("proportion_of_adequate_sleep_by_trouble.png", plot = p7, device = "png")
ggplotly(plotly_p7)
```


# Introduction 

The National Health and Nutrition Examination Survey (NHANES) is a program conducted by the Centers for Disease Control and Prevention (CDC) to assess the health and nutritional status of adults and children in the United States. NHANES collects data through interviews, physical examinations, and laboratory tests, making it a valuable resource for studying various health-related outcomes, such as the presence of a sufficient sleep duration. According to (Watson, 2015), Adults between 18 to 70 years old are suggested at least seven hours of sleep on average.

Despite sleep takes a crucial role in our health, sleeping disorders are becoming a huge concern in modern life. It is estimated that between 50 million and 70 million individuals are currently affected by persistent sleep disorders, with the most prevalent ones being insomnia, sleep apnea, and narcolepsy (NHLBI, 2022). These disorders not only impact an individual's quality of life but also carry substantial societal and economic impacts.

This study aims to investigate *the factors that correlates sleeping time in the NHANES dataset*. We initially hypothesize that sleeping quality, alcohol consumption, mental depression and heart disease are connected to how long they sleep. Understanding these relationships is crucial for informing interventions aimed at promoting healthier sleep habits and mitigating the adverse effects of sleep disorders. 

# Methods 

The datasets utilized in this study were obtained from the National Health and Nutrition Examination Survey (NHANES) website. From the variety of datasets available, five were selected for analysis: Geographical Information, Sleep Disorders, Mental Health-Depression Screener, Alcohol Use, and Cardiovascular Health., with a sample size of ranging from 6433 to 10195 and covering the time period between 2017 and March 2020 pre-pandemic.

The documentation provided with each dataset on the website was utilized to understand the variables and their meanings. Variable names were modified from question id to a summary of the content of the corresponding questions, while retaining numerical values to represent the extent of the variables. For example, in the Mental Health-Depression Screener dataset, a scale of 0 to 3 indicates the severance of Have little interest in doing things, from "not at all" to "almost everyday". For some of the questions, answers that indicate "refuse to answer" or "do not know" are modified to NA values. 

The missing value amount is huge by the nature of a questionnaire and mutation from negligible answer to NA values. To tackle this challenge, rather than gathering all available data, we opt to exclude questions with a high missing value rate and merge the sleep data with the relevant factors individually. Subsequently, we conduct our analysis while either excluding observations with missing values in the key variables or set missing values as a separate category.

The potential outliers are well addressed by the datasets. For example, if a person drinks more than 15 drinks (in which a drink represents the quantity of a 12 oz. beer, a 5 oz. glass of wine, or one and a half ounces of liquor) everyday in the past 12 months, this observation value would be a static 15.

Then besides the overall data cleaning, for each dataset, we modify as follows: 

For the Sleep Disorders dataset, the average sleeping duration is calculated from their sleeping duration on weekdays and weekends with a weight of 5/7 and 2/7, respectively, and the answer to the question "How often feel overly sleepy during day?" serves as an indicator the sleeping quality.

For the Alcohol Use dataset, we found that some variables were too specific and didn't contribute significantly to our analysis. Additionally, we observed that certain variables were already captured within broader variables. For instance, the qustion "Past 12 months how often drink alcoholic beverages" was a subset of "Average number of alcoholic drinks per day in the past 12 months." Therefore, to streamline our analysis and avoid redundancy, we excluded these specific variables and retained the broader ones that encompassed their information.

For the Mental Health-Depression Screener, a total score ranging from 0 to 27 was calculated based on complete responses to symptom questions. Pre-defined cut-points were applied to assess depression severity, with scores less than 10 indicating rare occurrence of major depressive episodes, and scores of 15 or greater suggesting the presence of a major depressive episode.[@Ehde2011] 

In the Cardiovascular Health dataset, angina classification into grade 1 and grade 2 is determined using the Rose questionnaire criteria (Rose, 1962). For the purposes of our analysis, individuals who have angina in either grade are categorized as having angina.


After cleaning the dataset, 



# Preliminary Results 

The histogram above shows the sleep duration distribution in general. We could note that there's a distinct difference in how sleep duration is distributed between weekdays and weekends. On weekdays, we observe a tendency for sleep duration to skew more towards the right, indicating shorter durations overall. Conversely, during weekends, the distribution shifts towards the left, suggesting longer sleep durations on average. This implies that people tend to get more sleep during weekends compared to weekdays. 

```{r, warning=FALSE}
ggplot(all_p_mr, aes(x = feel_sleepy_freq)) +
  geom_bar(fill = "skyblue", color = "black") +
  labs(title = "Distribution of Feel Sleepy", x = "Feel Sleepy", y = "Count") +
  coord_flip()
```

The barplot reveals that the majority of individuals tend to experience occasional (level 2) feelings of sleepiness, typically occurring around 2-4 times per month. It's worth noting that the distribution of this variable is not uniform, indicating a potential imbalance in the data.

```{r, warning=FALSE}
ggplot(all_p_m_plot, aes(x = duration_avg, fill = SLQ120)) +
  geom_boxplot() +
  labs(title = paste("Distribution of average duration by feel_sleepy"), x = "Average Duration", y = "Frequency") +
  facet_wrap(~ SLQ120) +
  coord_flip() +
  theme_minimal()
```

The histogram illustrates the distribution of average duration across various levels of feeling sleepy. Although the distributions are not notably distinct, it's evident that the sample sizes differ across the different levels of feeling sleepy. Interestingly, individuals who report feeling sleepy almost always (16-30 times a month) exhibit a slightly right-skewed distribution compared to those who experience sleepiness less frequently.

Additionally, we conducted a linear regression analysis to explore the relationship between different levels of the sleep quality indicator "feel_sleepy" and average sleep duration. Overall, the interpretation of the coefficients suggests that there are differences in average duration among different levels of feel_sleepy. Notably, the result suggests that, on average, feeling sleepier is associated with shorter sleep durations.  However, the relatively low R-squared value and some of the insignificant coefficient p-value indicates that the model explains only a small amount of the variance in duration_avg, suggesting that other factors not included in the model may also influence the duration.

One thing worth noticing apart from the initial hypothesis would be that on average, the level of snore frequency also negatively correlates with average sleep duration from the plot as well as the linear regression model. 

We could observe that most people drink a little, so both the plots are extremely right-skewed. While extreme values like 15 drinks per day over the past 12 months and drink everyday during the past 30 days exist, such observations may provide potential insights to the relationship between alcohol abuse and sleep duration.

After merging the alcohol use dataset and sleep disorder dataset, we could conduct a linear regression analysis, as the plot and model summary are shown above. The analysis revealed a statistically significant negative relationship between the frequency of alcohol consumption and average sleep duration. Specifically, for each additional instance of alcohol consumption in the past 30 days, there was a decrease of approximately 0.011 hours (about 40 seconds) in average sleep duration.

The model's adjusted R-squared value suggests that the frequency of alcohol consumption explains only a small portion of the variability in average sleep duration, indicating that other factors not included in the model may also influence sleep duration.

In summary, the histogram analysis reveals that due to imbalanced data, it's challenging to discern any substantial differences in distribution between groups aside from frequency counts.

Regarding the fitted linear regression model, the coefficient for the variable indicating the presence of angina is estimated to be approximately -0.06663. This suggests that, on average, individuals with symptoms related to angina have slightly shorter sleep durations. However, this finding is not statistically significant, with a p-value of 0.518, indicating that we cannot reject the null hypothesis.

Additionally, the adjusted R-squared value, which measures the proportion of variability explained by the model, is close to zero. This indicates that the model does not account for much of the variability in average sleep duration.

Overall, based on this analysis, there is insufficient evidence to suggest a significant relationship between the presence of angina and average sleep duration.

The analysis of the Depression Screener dataset reveals insignificant coefficients and distributions for each category of depression extent. Both the plots and the results of the linear regression indicate that the relationship between depression extent alone and average sleep duration is not statistically significant.

The coefficients for both "rare" and "severe" levels of depression extent are estimated to be 0.07602 and -0.16628, respectively. However, neither coefficient is statistically significant, as indicated by their p-values (0.270 and 0.126, respectively). This suggests that there is no significant association between the extent of depression symptoms and average sleep duration.

Additionally, the adjusted R-squared value is very close to zero, indicating that the model explains very little of the variability in average sleep duration.

In summary, similar to the Cardiovascular dataset results, the analysis of the Depression Screener dataset shows that neither the distribution nor the relationship between the extent of depression symptoms and average sleep duration is statistically significant.

# Summary 




# Bibliography

National Heart, Lung, and Blood Institute (NHLBI). (2022, March 24). Sleep deprivation and deficiency. https://www.nhlbi.nih.gov/health-topics/sleep-deprivation-and-deficiency

ROSE G. A. (1962). The diagnosis of ischaemic heart pain and intermittent claudication in field surveys. Bulletin of the World Health Organization, 27(6), 645–658.

Watson NF, Badr MS, Belenky G, et al. Recommended amount of sleep for a healthy adult: a joint consensus statement of the American Academy of Sleep Medicine and Sleep Research Society. Sleep. 2015;38(6):843–844.
